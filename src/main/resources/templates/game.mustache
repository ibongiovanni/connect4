
<SCRIPT LANGUAGE="JavaScript1.2">
   <!--
      NS4 = document.layers;
      if (NS4) {
         origWidth = innerWidth;
         origHeight = innerHeight;
      }   
   function reDo() {
      if (innerWidth != origWidth || innerHeight != origHeight) 
         location.reload();
   }   
   if (NS4) onresize = reDo;
   //-->
</SCRIPT>
<!DOCTYPE html>
<html>
	<head>
        {{> resources}}
        <script>
            var ord = {{ord}};
            var session = {{session}};

            function waitForMsg(){
              $.ajax({
                method: "GET",
                url: "/lastplay",
                dataType: "json",
                async: true,
                cache: false,
                data: {"ord": ord, "game_id": {{game_id}}},

                // success: function(data, stat, xhr){
                //   var num = data.cell;
                //   var cell = '#c'+num;
                //   $(cell).attr("class", data.coin);
                //   ord = data.ord;
                //   if (!data.finished) {
                //     setTimeout('waitForMsg()',1000);
                //   };
                // }
              }).done(function(data){
                  console.log(data);
                  ord = data.ord;
                  if (ord>0) updateView(data);
                  if (!data.finished) {
                    setTimeout('waitForMsg()',50);
                  };
                  
                  
                } 
              );
            }

            function reload (){
                    var game_id = this.id;
                    var column = this.value-1;
                    $(this).blur();
                    sendMove(game_id, column);
            }

            function sendMove(game_id, column){
                  disableAJAX();
                  $.ajax({
                         method: "POST",
                         url: "/drop2",
                         dataType: "json",
                         data: {"game_id": game_id, "column": column},
                    }).done( 
                        //updateView,
                        function (data){
                            if (!data.successful) {
                              $("#message").html(data.message).css("color",data.colored).css("border-color",data.colored);
                              enableAJAX();
                            };
                        }
                    );
            }

            function keymove(e){
                if (e.which>=49 && e.which<=55){
                    var column = e.which - 49;
                    sendMove({{game_id}},column);
                }
            }

            

            function updateView(data){
                $("#message").html(data.message).css("color",data.colored).css("border-color",data.colored);
                if (data.turn==session) {
                  $("#message").html("Is Your Turn!");
                  enableAJAX();
                }
                $("#audioSource").attr("src",data.sound);
                $(".sound").trigger("load");                
                $(".sound").trigger("play");
                if (data.finished) {
                    $("#endGameOptions").css("visibility","visible");
                    focusOnPlayAgain();
                    $("#playButtons").remove();
                    $("#message").css("margin-bottom","28px");
                    if (data.winner==session) {
                      $("#message").html("Congrats, You Won!")
                    };
                    if (data.winner) {
                        var coinImage = (data.winner=="{{p1id}}")? "yellowcoin.gif" : "redcoin.gif";
                        for (var i = 0; i < data.winCells.length; i++) {
                            $("#c"+data.winCells[i]).css('background-image', 'url(/'+coinImage+')');
                        };
                    };

                };
                if (data.successful) {
                    var cell = '#c'+data.cell;
                    $(cell).attr("class",data.coin);
                }
            }

            $(document).ready( function(){
              if(ord%2==0 && session=={{p1id}}){ //if is turn for p1 and u're p1
                enableAJAX();
                $("#message").html("You First!");
              }
              if (ord%2!=0 && session=={{p2id}}) { //if is turn for p2 and u're p2
                enableAJAX();
                $("#message").html("You First!");
              };
              waitForMsg();
            });

            function enableAJAX (data){
                $(".dropButton").on("click", reload);
                $(document).keydown(keymove);
                bindMuteButton();
                //console.log(data); 
            }

            function disableAJAX(){
                $(".dropButton").off();
                $(document).off();
            }

        </script>



        <script>
        function soundEnought(){
          setTimeout(timeSound,500);}
        </script>
        
        <script>
        function timeSound(){
          document.getElementById("enought").Play();}
        </script>

    </head>
    <body>
        {{> bodyboard}}
    </body>
</html>