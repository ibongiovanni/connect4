
<SCRIPT LANGUAGE="JavaScript1.2">
   <!--
      NS4 = document.layers;
      if (NS4) {
         origWidth = innerWidth;
         origHeight = innerHeight;
      }   
   function reDo() {
      if (innerWidth != origWidth || innerHeight != origHeight) 
         location.reload();
   }   
   if (NS4) onresize = reDo;
   //-->
</SCRIPT>
<!DOCTYPE html>
<html>
	<head>
        {{> resources}}
        <script>
        var ord = 0;

        function waitForMsg(){
          $.ajax({
            method: "GET",
            url: "/lastplay",
            dataType: "json",
            async: true,
            cache: false,
            data: {"ord": ord, "game_id": {{game_id}}},

            success: function(data, stat, xhr){
              //var json = eval('('+data+')');
              //console.log(data);
              //console.log(xhr);
              var num = data.cell;//json['cell'];
              var cell = '#c'+num;
              //console.log(cell);
              $(cell).attr("class", data.coin);//json['coin']);
              ord = data.ord;//json['ord'];
              //console.log(ord);
              if (!data.finished) {
                setTimeout('waitForMsg()',1000);
              };
            }
          }).done(function(data){
              console.log(data);
              updateView(data);
            } 
          );
        }
          
        </script>
        <script>

            function reload (){
                    //console.log(ev);
                    //console.log(this);
                    var game_id = this.id;
                    var column = this.value-1;
                    sendMove(game_id, column);
            }

            function sendMove(game_id, column){
                  $.ajax({
                         method: "POST",
                         url: "/drop2",
                         dataType: "json",
                         data: {"game_id": game_id, "column": column},
                    }).done( 
                        //updateView
                        // function (data){
                        //     $.publish(game_id,data);
                        // }
                    );
            }

            function keymove(e){
                if (e.which>=49 && e.which<=55){
                    var column = e.which - 49;
                    sendMove({{game_id}},column);
                }
            }

            $(document).keydown(keymove);

            function updateView(data){
                $("#message").html(data.message).css("color",data.colored).css("border-color",data.colored);
                $("#audioSource").attr("src",data.sound);
                $(".sound").trigger("load");                
                $(".sound").trigger("play");
                if (data.finished) {
                    $("#endGameOptions").css("visibility","visible");
                    focusOnPlayAgain();
                    $("#playButtons").remove();
                    $("#message").css("margin-bottom","30px");
                    if (data.winner) {
                        var coinImage = (data.winner=="1")? "yellowcoin.gif" : "redcoin.gif";
                        for (var i = 0; i < data.winCells.length; i++) {
                            $("#c"+data.winCells[i]).css('background-image', 'url(/'+coinImage+')');
                        };
                    };

                };
                if (data.successful) {
                    var cell = '#c'+data.cell;
                    $(cell).attr("class",data.coin);
                }
            }

            $(document).ready( function(){
              enableAJAX();
              waitForMsg();
            });

            function enableAJAX (data){
                $(".dropButton").on("click", reload);
                //console.log(data); 
            }

        </script>



        <script>
        function soundEnought(){
          setTimeout(timeSound,500);}
        </script>
        
        <script>
        function timeSound(){
          document.getElementById("enought").Play();}
        </script>

    </head>
    <body>
        {{> bodyboard}}
    </body>
</html>